# 🚀 yfinance & Plotly 完全マスターガイド
## ゼロから最上級レベルまでの完全手引書

---

## 📚 目次

1. [はじめに](#はじめに)
2. [環境セットアップ](#環境セットアップ)
3. [yfinance完全ガイド](#yfinance完全ガイド)
4. [Plotly完全ガイド](#plotly完全ガイド)
5. [実践統合編](#実践統合編)
6. [最上級テクニック](#最上級テクニック)
7. [トラブルシューティング](#トラブルシューティング)

---

## はじめに

### このガイドで学べること

- **yfinance**: Yahoo Financeから株価・財務データを取得するPythonライブラリ
- **Plotly**: インタラクティブで美しいグラフを作成するビジュアライゼーションライブラリ

### 前提知識

- Python基礎（変数、関数、クラス、データ型）
- pandas基礎（DataFrameの概念）
- 株式市場の基本用語（任意）

---

## 環境セットアップ

### インストール

```bash
# 必要なライブラリを一括インストール
pip install yfinance pandas plotly numpy

# または requirements.txt を使用
pip install -r requirements.txt
```

### requirements.txt の内容

```text
yfinance>=0.2.28
pandas>=2.0.0
plotly>=5.14.0
numpy>=1.24.0
```

### インポート確認

```python
import yfinance as yf
import pandas as pd
import plotly.graph_objects as go
import plotly.express as px
from plotly.subplots import make_subplots
import numpy as np
from datetime import datetime, timedelta

print("✅ すべてのライブラリが正常にインポートされました！")
```

---

## yfinance完全ガイド

### 🌟 Level 1: 基礎編

#### 1.1 単一銘柄の株価データ取得

```python
import yfinance as yf

# Tickerオブジェクトの作成
ticker = yf.Ticker("AAPL")

# 株価履歴を取得（デフォルトは最大期間）
hist = ticker.history(period="1mo")  # 1ヶ月分

print(hist.head())
# 出力: Date, Open, High, Low, Close, Volume, Dividends, Stock Splits
```

#### 1.2 期間の指定方法

```python
# 期間指定のバリエーション
hist_1d = ticker.history(period="1d")      # 1日
hist_5d = ticker.history(period="5d")      # 5日
hist_1mo = ticker.history(period="1mo")    # 1ヶ月
hist_3mo = ticker.history(period="3mo")    # 3ヶ月
hist_6mo = ticker.history(period="6mo")    # 6ヶ月
hist_1y = ticker.history(period="1y")      # 1年
hist_2y = ticker.history(period="2y")      # 2年
hist_5y = ticker.history(period="5y")      # 5年
hist_10y = ticker.history(period="10y")    # 10年
hist_ytd = ticker.history(period="ytd")    # 年初来
hist_max = ticker.history(period="max")    # 最大期間

# 日付範囲での指定
hist_range = ticker.history(start="2023-01-01", end="2023-12-31")
```

#### 1.3 インターバルの指定

```python
# 1分足データ（最大7日間）
hist_1m = ticker.history(period="5d", interval="1m")

# 利用可能なインターバル
# "1m", "2m", "5m", "15m", "30m", "60m", "90m"  # 分足
# "1h"                                           # 時間足
# "1d", "5d"                                     # 日足
# "1wk"                                          # 週足
# "1mo", "3mo"                                   # 月足
```

### 🌟 Level 2: 企業情報と財務データ

#### 2.1 基本情報の取得

```python
ticker = yf.Ticker("AAPL")
info = ticker.info

# 重要な情報の取得
print(f"企業名: {info.get('longName')}")
print(f"セクター: {info.get('sector')}")
print(f"産業: {info.get('industry')}")
print(f"時価総額: ${info.get('marketCap'):,}")
print(f"現在株価: ${info.get('currentPrice')}")
print(f"PER: {info.get('trailingPE'):.2f}")
print(f"配当利回り: {info.get('dividendYield', 0) * 100:.2f}%")
```

#### 2.2 利用可能な主要指標

```python
# バリュエーション指標
pe_ratio = info.get('trailingPE')          # PER（実績）
forward_pe = info.get('forwardPE')         # PER（予想）
pb_ratio = info.get('priceToBook')         # PBR
ps_ratio = info.get('priceToSalesTrailing12Months')  # PSR
peg_ratio = info.get('pegRatio')           # PEGレシオ

# 収益性指標
roe = info.get('returnOnEquity')           # ROE
roa = info.get('returnOnAssets')           # ROA
profit_margin = info.get('profitMargins')  # 利益率
operating_margin = info.get('operatingMargins')  # 営業利益率

# 財務健全性
debt_to_equity = info.get('debtToEquity')  # 負債比率
current_ratio = info.get('currentRatio')   # 流動比率
quick_ratio = info.get('quickRatio')       # 当座比率

# 成長性
revenue_growth = info.get('revenueGrowth') # 売上成長率
earnings_growth = info.get('earningsGrowth')  # 利益成長率

# 配当
dividend_rate = info.get('dividendRate')   # 配当金額
dividend_yield = info.get('dividendYield') # 配当利回り
payout_ratio = info.get('payoutRatio')     # 配当性向
```

#### 2.3 財務諸表データの取得

```python
ticker = yf.Ticker("AAPL")

# 損益計算書（Income Statement）
income_stmt = ticker.financials           # 年次
income_stmt_q = ticker.quarterly_financials  # 四半期

# 貸借対照表（Balance Sheet）
balance_sheet = ticker.balance_sheet      # 年次
balance_sheet_q = ticker.quarterly_balance_sheet  # 四半期

# キャッシュフロー計算書
cash_flow = ticker.cashflow               # 年次
cash_flow_q = ticker.quarterly_cashflow   # 四半期

# データの確認
print("利用可能な損益計算書の項目:")
print(income_stmt.index.tolist())

# 特定項目の取得
total_revenue = income_stmt.loc['Total Revenue']
net_income = income_stmt.loc['Net Income']
```

#### 2.4 財務データの活用例

```python
# 売上高の推移を取得
def get_revenue_trend(ticker_symbol):
    ticker = yf.Ticker(ticker_symbol)
    financials = ticker.financials.T  # 転置して年を行に
    
    if 'Total Revenue' in financials.columns:
        revenue = financials['Total Revenue'] / 1e9  # 10億ドル単位
        return revenue
    return None

# 使用例
revenue = get_revenue_trend("AAPL")
print(revenue)
```

### 🌟 Level 3: 複数銘柄とリアルタイムデータ

#### 3.1 複数銘柄の一括取得

```python
# 方法1: downloadを使用（推奨）
tickers = ["AAPL", "GOOGL", "MSFT", "TSLA"]
data = yf.download(tickers, start="2023-01-01", end="2023-12-31")

# Close価格のみ取得
close_prices = data['Close']
print(close_prices.head())

# 方法2: 個別にループ
results = {}
for ticker in tickers:
    stock = yf.Ticker(ticker)
    results[ticker] = stock.history(period="1y")
```

#### 3.2 リアルタイムデータの監視

```python
import time

def monitor_price(ticker_symbol, duration_seconds=60):
    """指定秒数、株価をモニタリング"""
    ticker = yf.Ticker(ticker_symbol)
    start_time = time.time()
    
    while (time.time() - start_time) < duration_seconds:
        # 最新データを取得
        hist = ticker.history(period="1d", interval="1m")
        current_price = hist['Close'][-1]
        
        print(f"{ticker_symbol}: ${current_price:.2f} "
              f"({datetime.now().strftime('%H:%M:%S')})")
        
        time.sleep(10)  # 10秒待機

# 使用例
# monitor_price("AAPL", 60)
```

### 🌟 Level 4: 高度なデータ処理

#### 4.1 テクニカル指標の計算

```python
def calculate_technical_indicators(ticker_symbol, period="1y"):
    """主要なテクニカル指標を計算"""
    ticker = yf.Ticker(ticker_symbol)
    df = ticker.history(period=period)
    
    # 移動平均
    df['SMA_20'] = df['Close'].rolling(window=20).mean()
    df['SMA_50'] = df['Close'].rolling(window=50).mean()
    df['SMA_200'] = df['Close'].rolling(window=200).mean()
    
    # 指数移動平均（EMA）
    df['EMA_12'] = df['Close'].ewm(span=12, adjust=False).mean()
    df['EMA_26'] = df['Close'].ewm(span=26, adjust=False).mean()
    
    # MACD
    df['MACD'] = df['EMA_12'] - df['EMA_26']
    df['Signal'] = df['MACD'].ewm(span=9, adjust=False).mean()
    
    # RSI (Relative Strength Index)
    delta = df['Close'].diff()
    gain = (delta.where(delta > 0, 0)).rolling(window=14).mean()
    loss = (-delta.where(delta < 0, 0)).rolling(window=14).mean()
    rs = gain / loss
    df['RSI'] = 100 - (100 / (1 + rs))
    
    # ボリンジャーバンド
    df['BB_Middle'] = df['Close'].rolling(window=20).mean()
    std = df['Close'].rolling(window=20).std()
    df['BB_Upper'] = df['BB_Middle'] + (std * 2)
    df['BB_Lower'] = df['BB_Middle'] - (std * 2)
    
    return df

# 使用例
df = calculate_technical_indicators("AAPL")
print(df[['Close', 'SMA_20', 'RSI', 'MACD']].tail())
```

#### 4.2 リスク指標の計算

```python
def calculate_risk_metrics(ticker_symbol, period="1y"):
    """リスク関連指標を計算"""
    ticker = yf.Ticker(ticker_symbol)
    df = ticker.history(period=period)
    
    # 日次リターン
    daily_returns = df['Close'].pct_change()
    
    # 年率リターン
    annual_return = daily_returns.mean() * 252
    
    # ボラティリティ（年率）
    volatility = daily_returns.std() * np.sqrt(252)
    
    # シャープレシオ（リスクフリーレート2%と仮定）
    risk_free_rate = 0.02
    sharpe_ratio = (annual_return - risk_free_rate) / volatility
    
    # 最大ドローダウン
    cumulative = (1 + daily_returns).cumprod()
    running_max = cumulative.expanding().max()
    drawdown = (cumulative - running_max) / running_max
    max_drawdown = drawdown.min()
    
    # VaR (Value at Risk) - 95%信頼区間
    var_95 = np.percentile(daily_returns.dropna(), 5)
    
    return {
        'annual_return': annual_return,
        'volatility': volatility,
        'sharpe_ratio': sharpe_ratio,
        'max_drawdown': max_drawdown,
        'var_95': var_95
    }

# 使用例
metrics = calculate_risk_metrics("AAPL")
for key, value in metrics.items():
    print(f"{key}: {value:.4f}")
```

#### 4.3 日本株式の取得

```python
# 日本株はティッカーに「.T」を付ける
japanese_stocks = {
    '7203.T': 'トヨタ自動車',
    '6758.T': 'ソニーグループ',
    '9984.T': 'ソフトバンクグループ',
    '6861.T': 'キーエンス',
    '7974.T': '任天堂'
}

# データ取得
for ticker, name in japanese_stocks.items():
    stock = yf.Ticker(ticker)
    info = stock.info
    hist = stock.history(period="1mo")
    
    print(f"\n{name} ({ticker})")
    print(f"現在株価: ¥{info.get('currentPrice', 'N/A')}")
    print(f"時価総額: ¥{info.get('marketCap', 0):,}")
```

---

## Plotly完全ガイド

### 🌟 Level 1: 基礎編

#### 1.1 Plotlyの2つの主要インターフェース

```python
import plotly.graph_objects as go  # 低レベル、詳細な制御
import plotly.express as px        # 高レベル、簡単・高速

# Expressの例（簡単）
df = px.data.iris()
fig = px.scatter(df, x="sepal_width", y="sepal_length", color="species")
fig.show()

# Graph Objectsの例（詳細な制御）
fig = go.Figure(data=go.Scatter(x=[1, 2, 3], y=[4, 5, 6]))
fig.show()
```

#### 1.2 基本的な折れ線グラフ

```python
import plotly.graph_objects as go
import yfinance as yf

# データ取得
ticker = yf.Ticker("AAPL")
df = ticker.history(period="1y")

# グラフ作成
fig = go.Figure()

fig.add_trace(go.Scatter(
    x=df.index,
    y=df['Close'],
    mode='lines',
    name='株価',
    line=dict(color='blue', width=2)
))

fig.update_layout(
    title='Apple 株価推移',
    xaxis_title='日付',
    yaxis_title='株価 (USD)',
    template='plotly_white'
)

fig.show()
```

#### 1.3 基本的なローソク足チャート

```python
# ローソク足チャート
fig = go.Figure(data=[go.Candlestick(
    x=df.index,
    open=df['Open'],
    high=df['High'],
    low=df['Low'],
    close=df['Close'],
    name='AAPL'
)])

fig.update_layout(
    title='Apple ローソク足チャート',
    yaxis_title='株価 (USD)',
    xaxis_rangeslider_visible=False  # 下部のレンジスライダーを非表示
)

fig.show()
```

### 🌟 Level 2: 複数トレースとレイアウト

#### 2.1 複数の線を1つのグラフに

```python
# 複数銘柄の比較
tickers = ["AAPL", "GOOGL", "MSFT"]
data = yf.download(tickers, start="2023-01-01", end="2023-12-31")

fig = go.Figure()

colors = ['blue', 'red', 'green']
for i, ticker in enumerate(tickers):
    fig.add_trace(go.Scatter(
        x=data.index,
        y=data['Close'][ticker],
        mode='lines',
        name=ticker,
        line=dict(color=colors[i], width=2)
    ))

fig.update_layout(
    title='テック株3社の比較',
    xaxis_title='日付',
    yaxis_title='株価 (USD)',
    hovermode='x unified',  # ホバー時に全銘柄表示
    template='plotly_white'
)

fig.show()
```

#### 2.2 副軸（セカンダリY軸）の使用

```python
# 株価と出来高を同時表示
ticker = yf.Ticker("AAPL")
df = ticker.history(period="6mo")

fig = go.Figure()

# 株価（主軸）
fig.add_trace(go.Scatter(
    x=df.index,
    y=df['Close'],
    name='株価',
    yaxis='y1'
))

# 出来高（副軸）
fig.add_trace(go.Bar(
    x=df.index,
    y=df['Volume'],
    name='出来高',
    yaxis='y2',
    opacity=0.3
))

fig.update_layout(
    title='株価と出来高',
    yaxis=dict(title='株価 (USD)'),
    yaxis2=dict(
        title='出来高',
        overlaying='y',
        side='right'
    ),
    template='plotly_white'
)

fig.show()
```

#### 2.3 レイアウトのカスタマイズ

```python
fig.update_layout(
    # タイトル
    title={
        'text': 'カスタマイズされたタイトル',
        'x': 0.5,  # 中央揃え
        'font': {'size': 24, 'color': '#333'}
    },
    
    # 軸
    xaxis={
        'title': 'X軸タイトル',
        'showgrid': True,
        'gridcolor': '#e0e0e0',
        'tickfont': {'size': 12}
    },
    yaxis={
        'title': 'Y軸タイトル',
        'showgrid': True,
        'gridcolor': '#e0e0e0'
    },
    
    # 背景色
    plot_bgcolor='white',
    paper_bgcolor='#f8f9fa',
    
    # サイズ
    width=1200,
    height=600,
    
    # 凡例
    legend=dict(
        x=0.01,
        y=0.99,
        bgcolor='rgba(255, 255, 255, 0.8)',
        bordercolor='#ccc',
        borderwidth=1
    ),
    
    # ホバー
    hovermode='x unified'
)
```

### 🌟 Level 3: サブプロット

#### 3.1 基本的なサブプロット

```python
from plotly.subplots import make_subplots

# 2行1列のサブプロット
fig = make_subplots(
    rows=2, cols=1,
    subplot_titles=('株価', '出来高'),
    vertical_spacing=0.1
)

ticker = yf.Ticker("AAPL")
df = ticker.history(period="6mo")

# 1行目: 株価
fig.add_trace(
    go.Scatter(x=df.index, y=df['Close'], name='株価'),
    row=1, col=1
)

# 2行目: 出来高
fig.add_trace(
    go.Bar(x=df.index, y=df['Volume'], name='出来高'),
    row=2, col=1
)

fig.update_layout(height=800, showlegend=False)
fig.show()
```

#### 3.2 複雑なグリッドレイアウト

```python
# 2x2のグリッド
fig = make_subplots(
    rows=2, cols=2,
    subplot_titles=('株価', 'RSI', '出来高', 'MACD'),
    specs=[
        [{"secondary_y": False}, {"secondary_y": False}],
        [{"secondary_y": False}, {"secondary_y": True}]
    ]
)

# 各サブプロットにデータを追加
# row, col で位置を指定
fig.add_trace(go.Scatter(...), row=1, col=1)
fig.add_trace(go.Scatter(...), row=1, col=2)
fig.add_trace(go.Bar(...), row=2, col=1)
fig.add_trace(go.Scatter(...), row=2, col=2)
```

#### 3.3 異なる種類のサブプロット

```python
from plotly.subplots import make_subplots
import plotly.graph_objects as go

fig = make_subplots(
    rows=2, cols=2,
    specs=[
        [{"type": "scatter"}, {"type": "bar"}],
        [{"type": "candlestick", "colspan": 2}, None]
    ],
    subplot_titles=('折れ線', '棒グラフ', 'ローソク足')
)

# データは上記と同様に追加
```

### 🌟 Level 4: 高度なグラフタイプ

#### 4.1 インジケーター（ゲージ、メーター）

```python
# ゲージチャート
fig = go.Figure(go.Indicator(
    mode="gauge+number+delta",
    value=25.5,
    delta={'reference': 20},
    domain={'x': [0, 1], 'y': [0, 1]},
    title={'text': "PER"},
    gauge={
        'axis': {'range': [None, 50]},
        'bar': {'color': "darkblue"},
        'steps': [
            {'range': [0, 15], 'color': "lightgreen"},
            {'range': [15, 25], 'color': "yellow"},
            {'range': [25, 50], 'color': "lightcoral"}
        ],
        'threshold': {
            'line': {'color': "red", 'width': 4},
            'thickness': 0.75,
            'value': 35
        }
    }
))

fig.show()
```

#### 4.2 レーダーチャート（スパイダーチャート）

```python
# 財務指標のレーダーチャート
categories = ['収益性', '成長性', '安全性', '効率性', '流動性']
values = [80, 65, 90, 75, 85]

fig = go.Figure()

fig.add_trace(go.Scatterpolar(
    r=values + [values[0]],  # 最初の値を最後に追加して閉じる
    theta=categories + [categories[0]],
    fill='toself',
    name='企業A',
    line=dict(color='blue'),
    fillcolor='rgba(0, 0, 255, 0.2)'
))

fig.update_layout(
    polar=dict(
        radialaxis=dict(
            visible=True,
            range=[0, 100]
        )
    ),
    showlegend=False
)

fig.show()
```

#### 4.3 テーブル

```python
# データテーブル
fig = go.Figure(data=[go.Table(
    header=dict(
        values=['銘柄', '株価', 'PER', 'ROE', '評価'],
        fill_color='paleturquoise',
        align='left',
        font=dict(size=14, color='white')
    ),
    cells=dict(
        values=[
            ['AAPL', 'GOOGL', 'MSFT'],
            ['$175', '$140', '$380'],
            ['25.5', '22.3', '30.1'],
            ['18%', '15%', '21%'],
            ['良好', '良好', '普通']
        ],
        fill_color='lavender',
        align='left',
        font=dict(size=12)
    )
)])

fig.show()
```

#### 4.4 ヒートマップ

```python
# 相関行列のヒートマップ
import pandas as pd

tickers = ["AAPL", "GOOGL", "MSFT", "TSLA"]
data = yf.download(tickers, start="2023-01-01")['Close']
correlation = data.corr()

fig = go.Figure(data=go.Heatmap(
    z=correlation.values,
    x=correlation.columns,
    y=correlation.columns,
    colorscale='RdBu',
    zmid=0,
    text=correlation.values.round(2),
    texttemplate='%{text}',
    textfont={"size": 12}
))

fig.update_layout(
    title='銘柄間の相関係数',
    width=600,
    height=600
)

fig.show()
```

### 🌟 Level 5: インタラクティブ機能

#### 5.1 ボタンとドロップダウン

```python
# 複数期間を切り替えるボタン
ticker = yf.Ticker("AAPL")

# 異なる期間のデータを用意
periods = ['1mo', '3mo', '6mo', '1y']
data_dict = {period: ticker.history(period=period) for period in periods}

# 最初の期間でグラフ作成
fig = go.Figure()
fig.add_trace(go.Scatter(
    x=data_dict['1mo'].index,
    y=data_dict['1mo']['Close'],
    name='株価'
))

# ボタンでデータを切り替え
buttons = []
for period, df in data_dict.items():
    buttons.append(
        dict(
            label=period,
            method='update',
            args=[
                {'x': [df.index], 'y': [df['Close']]},
                {'title': f'Apple 株価 ({period})'}
            ]
        )
    )

fig.update_layout(
    updatemenus=[
        dict(
            type='buttons',
            direction='left',
            buttons=buttons,
            x=0.1,
            y=1.15
        )
    ]
)

fig.show()
```

#### 5.2 スライダー

```python
# 時系列データをスライダーで制御
import pandas as pd

ticker = yf.Ticker("AAPL")
df = ticker.history(period="1y")

fig = go.Figure()

# 全データを追加
fig.add_trace(go.Scatter(
    x=df.index,
    y=df['Close'],
    mode='lines',
    name='株価'
))

# スライダーのステップを作成
steps = []
for i in range(0, len(df), 30):  # 30日ごと
    step = dict(
        method="update",
        args=[{"visible": [True]},
              {"xaxis": {"range": [df.index[i], df.index[min(i+90, len(df)-1)]]}}],
        label=df.index[i].strftime('%Y-%m')
    )
    steps.append(step)

# スライダーを追加
sliders = [dict(
    active=0,
    steps=steps,
    x=0.1,
    y=0,
    currentvalue={"prefix": "期間: "},
    pad={"t": 50}
)]

fig.update_layout(sliders=sliders)
fig.show()
```

#### 5.3 ホバーのカスタマイズ

```python
fig = go.Figure()

fig.add_trace(go.Scatter(
    x=df.index,
    y=df['Close'],
    mode='lines',
    name='株価',
    hovertemplate='<b>日付</b>: %{x|%Y-%m-%d}<br>' +
                  '<b>株価</b>: $%{y:.2f}<br>' +
                  '<extra></extra>'  # 右上のトレース名を非表示
))

# グローバルなホバー設定
fig.update_layout(
    hovermode='x unified',  # X軸で統一
    hoverlabel=dict(
        bgcolor="white",
        font_size=12,
        font_family="Arial"
    )
)
```

---

## 実践統合編

### 🚀 統合プロジェクト1: 基本的な株価ダッシュボード

```python
def create_basic_dashboard(ticker_symbol):
    """シンプルな株価ダッシュボード"""
    ticker = yf.Ticker(ticker_symbol)
    df = ticker.history(period="1y")
    info = ticker.info
    
    # 2x2のダッシュボード
    fig = make_subplots(
        rows=2, cols=2,
        subplot_titles=[
            '株価推移',
            '出来高',
            '高値・安値範囲',
            '月次リターン'
        ],
        specs=[
            [{"secondary_y": False}, {"secondary_y": False}],
            [{"secondary_y": False}, {"secondary_y": False}]
        ]
    )
    
    # 1. 株価推移
    fig.add_trace(
        go.Scatter(x=df.index, y=df['Close'], name='終値',
                  line=dict(color='blue')),
        row=1, col=1
    )
    
    # 2. 出来高
    fig.add_trace(
        go.Bar(x=df.index, y=df['Volume'], name='出来高',
               marker_color='lightblue'),
        row=1, col=2
    )
    
    # 3. 高値・安値範囲
    fig.add_trace(
        go.Scatter(x=df.index, y=df['High'], name='高値',
                  line=dict(color='green', dash='dash')),
        row=2, col=1
    )
    fig.add_trace(
        go.Scatter(x=df.index, y=df['Low'], name='安値',
                  line=dict(color='red', dash='dash'),
                  fill='tonexty'),
        row=2, col=1
    )
    
    # 4. 月次リターン
    monthly_returns = df['Close'].resample('M').last().pct_change()
    colors = ['green' if x > 0 else 'red' for x in monthly_returns]
    fig.add_trace(
        go.Bar(x=monthly_returns.index, y=monthly_returns * 100,
               name='月次リターン', marker_color=colors),
        row=2, col=2
    )
    
    # レイアウト設定
    fig.update_layout(
        height=800,
        title_text=f"{ticker_symbol} - {info.get('longName', ticker_symbol)} ダッシュボード",
        showlegend=False
    )
    
    fig.update_yaxes(title_text="株価 (USD)", row=1, col=1)
    fig.update_yaxes(title_text="出来高", row=1, col=2)
    fig.update_yaxes(title_text="株価 (USD)", row=2, col=1)
    fig.update_yaxes(title_text="リターン (%)", row=2, col=2)
    
    return fig

# 使用例
fig = create_basic_dashboard("AAPL")
fig.show()
```

### 🚀 統合プロジェクト2: テクニカル分析ダッシュボード

```python
def create_technical_dashboard(ticker_symbol, period="1y"):
    """テクニカル分析ダッシュボード"""
    ticker = yf.Ticker(ticker_symbol)
    df = ticker.history(period=period)
    
    # テクニカル指標を計算
    df['SMA_20'] = df['Close'].rolling(window=20).mean()
    df['SMA_50'] = df['Close'].rolling(window=50).mean()
    
    # RSI
    delta = df['Close'].diff()
    gain = delta.where(delta > 0, 0).rolling(window=14).mean()
    loss = -delta.where(delta < 0, 0).rolling(window=14).mean()
    rs = gain / loss
    df['RSI'] = 100 - (100 / (1 + rs))
    
    # MACD
    exp1 = df['Close'].ewm(span=12, adjust=False).mean()
    exp2 = df['Close'].ewm(span=26, adjust=False).mean()
    df['MACD'] = exp1 - exp2
    df['Signal'] = df['MACD'].ewm(span=9, adjust=False).mean()
    
    # サブプロット作成
    fig = make_subplots(
        rows=3, cols=1,
        subplot_titles=['株価 & 移動平均', 'RSI', 'MACD'],
        vertical_spacing=0.08,
        row_heights=[0.5, 0.25, 0.25]
    )
    
    # 1. ローソク足 & 移動平均
    fig.add_trace(go.Candlestick(
        x=df.index,
        open=df['Open'],
        high=df['High'],
        low=df['Low'],
        close=df['Close'],
        name='OHLC'
    ), row=1, col=1)
    
    fig.add_trace(go.Scatter(
        x=df.index, y=df['SMA_20'],
        name='SMA 20', line=dict(color='orange', width=1)
    ), row=1, col=1)
    
    fig.add_trace(go.Scatter(
        x=df.index, y=df['SMA_50'],
        name='SMA 50', line=dict(color='blue', width=1)
    ), row=1, col=1)
    
    # 2. RSI
    fig.add_trace(go.Scatter(
        x=df.index, y=df['RSI'],
        name='RSI', line=dict(color='purple')
    ), row=2, col=1)
    
    # RSIの70と30のライン
    fig.add_hline(y=70, line_dash="dash", line_color="red",
                  annotation_text="Overbought", row=2, col=1)
    fig.add_hline(y=30, line_dash="dash", line_color="green",
                  annotation_text="Oversold", row=2, col=1)
    
    # 3. MACD
    fig.add_trace(go.Scatter(
        x=df.index, y=df['MACD'],
        name='MACD', line=dict(color='blue')
    ), row=3, col=1)
    
    fig.add_trace(go.Scatter(
        x=df.index, y=df['Signal'],
        name='Signal', line=dict(color='orange')
    ), row=3, col=1)
    
    # ヒストグラム
    macd_hist = df['MACD'] - df['Signal']
    colors = ['green' if val >= 0 else 'red' for val in macd_hist]
    fig.add_trace(go.Bar(
        x=df.index, y=macd_hist,
        name='Histogram', marker_color=colors
    ), row=3, col=1)
    
    # レイアウト
    fig.update_layout(
        height=1000,
        title_text=f"{ticker_symbol} テクニカル分析",
        xaxis_rangeslider_visible=False
    )
    
    fig.update_yaxes(title_text="株価", row=1, col=1)
    fig.update_yaxes(title_text="RSI", row=2, col=1)
    fig.update_yaxes(title_text="MACD", row=3, col=1)
    
    return fig

# 使用例
fig = create_technical_dashboard("AAPL")
fig.show()
```

### 🚀 統合プロジェクト3: ポートフォリオ分析

```python
def create_portfolio_dashboard(tickers_dict, start_date, end_date):
    """
    ポートフォリオ分析ダッシュボード
    tickers_dict: {'AAPL': 10, 'GOOGL': 5, 'MSFT': 8}  # 銘柄: 株数
    """
    # データ取得
    tickers = list(tickers_dict.keys())
    data = yf.download(tickers, start=start_date, end=end_date)['Close']
    
    # ポートフォリオ価値の計算
    portfolio_value = sum([data[ticker] * shares 
                          for ticker, shares in tickers_dict.items()])
    
    # リターン計算
    returns = data.pct_change()
    portfolio_returns = sum([returns[ticker] * tickers_dict[ticker] 
                            for ticker in tickers]) / sum(tickers_dict.values())
    
    # サブプロット
    fig = make_subplots(
        rows=2, cols=2,
        subplot_titles=[
            'ポートフォリオ価値推移',
            '構成銘柄の比率',
            '累積リターン',
            '銘柄別パフォーマンス'
        ],
        specs=[
            [{"secondary_y": False}, {"type": "pie"}],
            [{"secondary_y": False}, {"secondary_y": False}]
        ]
    )
    
    # 1. ポートフォリオ価値
    fig.add_trace(go.Scatter(
        x=portfolio_value.index,
        y=portfolio_value,
        fill='tonexty',
        name='ポートフォリオ'
    ), row=1, col=1)
    
    # 2. 構成比率（パイチャート）
    current_prices = data.iloc[-1]
    values = [current_prices[ticker] * shares 
              for ticker, shares in tickers_dict.items()]
    
    fig.add_trace(go.Pie(
        labels=tickers,
        values=values,
        name='構成比'
    ), row=1, col=2)
    
    # 3. 累積リターン
    cumulative_returns = (1 + portfolio_returns).cumprod()
    fig.add_trace(go.Scatter(
        x=cumulative_returns.index,
        y=(cumulative_returns - 1) * 100,
        name='累積リターン'
    ), row=2, col=1)
    
    # 4. 銘柄別パフォーマンス
    for ticker in tickers:
        ticker_return = ((data[ticker].iloc[-1] / data[ticker].iloc[0]) - 1) * 100
        fig.add_trace(go.Bar(
            x=[ticker],
            y=[ticker_return],
            name=ticker
        ), row=2, col=2)
    
    fig.update_layout(
        height=900,
        title_text="ポートフォリオ分析ダッシュボード",
        showlegend=False
    )
    
    return fig

# 使用例
portfolio = {
    'AAPL': 10,
    'GOOGL': 5,
    'MSFT': 8,
    'TSLA': 3
}

fig = create_portfolio_dashboard(
    portfolio,
    start_date="2023-01-01",
    end_date="2023-12-31"
)
fig.show()
```

---

## 最上級テクニック

### 💎 高度なカスタマイゼーション

#### 1. カスタムテーマの作成

```python
# カスタムテーマ
custom_theme = {
    'layout': go.Layout(
        font=dict(family="Arial, sans-serif", size=12, color="#333"),
        title=dict(font=dict(size=20, color="#1f2937")),
        plot_bgcolor='white',
        paper_bgcolor='#f8fafc',
        xaxis=dict(
            showgrid=True,
            gridcolor='#e5e7eb',
            linecolor='#d1d5db'
        ),
        yaxis=dict(
            showgrid=True,
            gridcolor='#e5e7eb',
            linecolor='#d1d5db'
        )
    )
}

# テーマの適用
fig = go.Figure(layout=custom_theme['layout'])
fig.add_trace(go.Scatter(x=[1,2,3], y=[4,5,6]))
fig.show()
```

#### 2. アノテーション（注釈）の追加

```python
ticker = yf.Ticker("AAPL")
df = ticker.history(period="1y")

fig = go.Figure()
fig.add_trace(go.Scatter(x=df.index, y=df['Close'], name='株価'))

# 最高値にアノテーション
max_idx = df['Close'].idxmax()
max_price = df['Close'].max()

fig.add_annotation(
    x=max_idx,
    y=max_price,
    text=f"最高値<br>${max_price:.2f}",
    showarrow=True,
    arrowhead=2,
    arrowcolor="red",
    ax=-40,
    ay=-40,
    bgcolor="white",
    bordercolor="red"
)

# 期間を示す矩形
fig.add_vrect(
    x0="2023-06-01",
    x1="2023-09-01",
    fillcolor="green",
    opacity=0.1,
    annotation_text="好調期",
    annotation_position="top left"
)

fig.show()
```

#### 3. カスタムホバーテンプレート

```python
# 高度なホバーテンプレート
ticker = yf.Ticker("AAPL")
df = ticker.history(period="6mo")

# 日次変動を計算
df['Change'] = df['Close'].diff()
df['Change_pct'] = df['Close'].pct_change() * 100

fig = go.Figure()

fig.add_trace(go.Scatter(
    x=df.index,
    y=df['Close'],
    mode='lines+markers',
    name='株価',
    customdata=np.column_stack((df['Change'], df['Change_pct'], df['Volume'])),
    hovertemplate='<b>%{x|%Y年%m月%d日}</b><br>' +
                  '終値: $%{y:.2f}<br>' +
                  '変動: $%{customdata[0]:+.2f} (%{customdata[1]:+.2f}%)<br>' +
                  '出来高: %{customdata[2]:,.0f}<br>' +
                  '<extra></extra>'
))

fig.show()
```

### 💎 パフォーマンス最適化

#### 1. 大量データの処理

```python
# データのダウンサンプリング
def downsample_data(df, max_points=1000):
    """大量データを間引く"""
    if len(df) <= max_points:
        return df
    
    step = len(df) // max_points
    return df.iloc[::step]

# 使用例
ticker = yf.Ticker("AAPL")
df = ticker.history(period="max")  # 全履歴
df_sampled = downsample_data(df, max_points=500)

fig = go.Figure()
fig.add_trace(go.Scatter(x=df_sampled.index, y=df_sampled['Close']))
fig.show()
```

#### 2. 非表示トレースの活用

```python
# 初期状態で一部のトレースを非表示
fig = go.Figure()

# 常に表示
fig.add_trace(go.Scatter(
    x=df.index, y=df['Close'],
    name='終値', visible=True
))

# 初期状態で非表示
fig.add_trace(go.Scatter(
    x=df.index, y=df['SMA_20'],
    name='SMA 20', visible='legendonly'  # 凡例クリックで表示
))

fig.add_trace(go.Scatter(
    x=df.index, y=df['SMA_50'],
    name='SMA 50', visible='legendonly'
))

fig.show()
```

### 💎 高度な分析テクニック

#### 1. 動的相関分析

```python
def rolling_correlation_heatmap(ticker1, ticker2, window=30):
    """ローリング相関のヒートマップ"""
    data = yf.download([ticker1, ticker2], period="1y")['Close']
    
    # ローリング相関を計算
    rolling_corr = data[ticker1].rolling(window=window).corr(data[ticker2])
    
    # 2Dヒートマップ用にデータを整形
    dates = rolling_corr.index
    z_data = rolling_corr.values.reshape(-1, 1)
    
    fig = go.Figure(data=go.Heatmap(
        z=z_data.T,
        x=dates,
        y=[f'{ticker1} vs {ticker2}'],
        colorscale='RdBu',
        zmid=0,
        colorbar=dict(title="相関係数")
    ))
    
    fig.update_layout(
        title=f'{ticker1}と{ticker2}のローリング相関（{window}日）',
        height=300
    )
    
    return fig

# 使用例
fig = rolling_correlation_heatmap("AAPL", "MSFT", window=30)
fig.show()
```

#### 2. ボラティリティコーンの作成

```python
def create_volatility_cone(ticker_symbol, periods=[10, 20, 30, 60, 90]):
    """ボラティリティコーンの作成"""
    ticker = yf.Ticker(ticker_symbol)
    df = ticker.history(period="1y")
    returns = df['Close'].pct_change().dropna()
    
    percentiles = [10, 25, 50, 75, 90]
    results = {p: [] for p in percentiles}
    
    for period in periods:
        rolling_vol = returns.rolling(window=period).std() * np.sqrt(252) * 100
        for pct in percentiles:
            results[pct].append(np.percentile(rolling_vol.dropna(), pct))
    
    fig = go.Figure()
    
    colors = ['#ef4444', '#f97316', '#10b981', '#3b82f6', '#8b5cf6']
    for i, pct in enumerate(percentiles):
        fig.add_trace(go.Scatter(
            x=periods,
            y=results[pct],
            name=f'{pct}th percentile',
            line=dict(color=colors[i])
        ))
    
    fig.update_layout(
        title=f'{ticker_symbol} ボラティリティコーン',
        xaxis_title='期間（日）',
        yaxis_title='年率ボラティリティ (%)',
        hovermode='x unified'
    )
    
    return fig

# 使用例
fig = create_volatility_cone("AAPL")
fig.show()
```

#### 3. イベント分析

```python
def analyze_event_impact(ticker_symbol, event_date, window_days=30):
    """特定イベント前後の株価分析"""
    ticker = yf.Ticker(ticker_symbol)
    
    # イベント前後のデータを取得
    start_date = (pd.to_datetime(event_date) - 
                 timedelta(days=window_days)).strftime('%Y-%m-%d')
    end_date = (pd.to_datetime(event_date) + 
               timedelta(days=window_days)).strftime('%Y-%m-%d')
    
    df = ticker.history(start=start_date, end=end_date)
    
    # イベント日を0として正規化
    event_idx = df.index.get_indexer([event_date], method='nearest')[0]
    df['Days_from_event'] = range(-event_idx, len(df) - event_idx)
    
    # イベント日の価格を100として正規化
    event_price = df.iloc[event_idx]['Close']
    df['Normalized_price'] = (df['Close'] / event_price) * 100
    
    fig = go.Figure()
    
    fig.add_trace(go.Scatter(
        x=df['Days_from_event'],
        y=df['Normalized_price'],
        mode='lines+markers',
        name='株価（正規化）'
    ))
    
    # イベント日に垂直線
    fig.add_vline(x=0, line_dash="dash", line_color="red",
                 annotation_text="イベント日")
    
    # 100のライン
    fig.add_hline(y=100, line_dash="dot", line_color="gray")
    
    fig.update_layout(
        title=f'{ticker_symbol} イベント分析（{event_date}）',
        xaxis_title='イベントからの日数',
        yaxis_title='正規化株価（イベント日=100）'
    )
    
    return fig

# 使用例
fig = analyze_event_impact("AAPL", "2023-09-12", window_days=45)
fig.show()
```

---

## トラブルシューティング

### ❗ よくある問題と解決法

#### 1. データ取得の問題

```python
# 問題: データが取得できない
# 解決法: エラーハンドリングとリトライ

import time

def safe_get_data(ticker_symbol, max_retries=3):
    """安全なデータ取得"""
    for attempt in range(max_retries):
        try:
            ticker = yf.Ticker(ticker_symbol)
            df = ticker.history(period="1y")
            
            if df.empty:
                raise ValueError(f"データが空です: {ticker_symbol}")
            
            return df
        
        except Exception as e:
            print(f"試行 {attempt + 1}/{max_retries} 失敗: {e}")
            if attempt < max_retries - 1:
                time.sleep(2 ** attempt)  # 指数バックオフ
            else:
                raise
    
    return None
```

#### 2. メモリの問題

```python
# 問題: 大量データでメモリ不足
# 解決法: チャンクごとに処理

def process_large_dataset(tickers, chunk_size=10):
    """大量の銘柄を分割処理"""
    results = []
    
    for i in range(0, len(tickers), chunk_size):
        chunk = tickers[i:i+chunk_size]
        data = yf.download(chunk, period="1y")
        results.append(data)
        
        # メモリをクリア
        import gc
        gc.collect()
    
    return pd.concat(results, axis=1)
```

#### 3. 日本株式のデータ問題

```python
# 問題: 日本株のデータが正しく取得できない
# 解決法: .T サフィックスと通貨の確認

def get_japanese_stock(ticker_code):
    """日本株式の安全な取得"""
    # .T サフィックスを追加
    if not ticker_code.endswith('.T'):
        ticker_code += '.T'
    
    ticker = yf.Ticker(ticker_code)
    df = ticker.history(period="1y")
    info = ticker.info
    
    # 通貨を確認
    currency = info.get('currency', 'JPY')
    print(f"通貨: {currency}")
    
    return df, info

# 使用例
df, info = get_japanese_stock("7203")  # トヨタ
```

#### 4. グラフが表示されない

```python
# 問題: Plotlyのグラフが表示されない
# 解決法:

# Jupyter Notebookの場合
import plotly.io as pio
pio.renderers.default = "notebook"

# ブラウザで開く場合
fig.show()

# HTMLファイルとして保存
fig.write_html("output.html")

# 画像として保存（kaleido必要）
# pip install kaleido
fig.write_image("output.png")
```

#### 5. パフォーマンスの問題

```python
# 問題: グラフの描画が遅い
# 解決法:

# 1. データポイントを減らす
df_resampled = df.resample('W').last()  # 週次にリサンプル

# 2. Scatterglを使用（WebGL版）
fig.add_trace(go.Scattergl(  # glを追加
    x=df.index,
    y=df['Close'],
    mode='lines'
))

# 3. 簡略化されたホバーテンプレート
fig.update_traces(hovertemplate='%{y:.2f}')
```

### 💡 ベストプラクティス

#### 1. データ検証

```python
def validate_data(df, ticker_symbol):
    """データの妥当性をチェック"""
    if df is None or df.empty:
        raise ValueError(f"データが空です: {ticker_symbol}")
    
    # 欠損値のチェック
    missing = df.isnull().sum()
    if missing.any():
        print(f"⚠️ 欠損値: {missing[missing > 0]}")
    
    # 異常値のチェック
    price_change = df['Close'].pct_change()
    extreme_moves = price_change[abs(price_change) > 0.2]
    if not extreme_moves.empty:
        print(f"⚠️ 異常な価格変動を検出:")
        print(extreme_moves)
    
    return True
```

#### 2. エラーログの記録

```python
import logging

# ロギング設定
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s',
    filename='stock_analysis.log'
)

def logged_data_fetch(ticker_symbol):
    """ログ付きデータ取得"""
    logging.info(f"データ取得開始: {ticker_symbol}")
    
    try:
        ticker = yf.Ticker(ticker_symbol)
        df = ticker.history(period="1y")
        logging.info(f"データ取得成功: {len(df)}行")
        return df
    
    except Exception as e:
        logging.error(f"データ取得失敗: {ticker_symbol} - {e}")
        raise
```

---

## 📝 まとめ

### 学習の進め方

1. **Level 1-2**: 基礎を固める（1-2週間）
   - 単一銘柄のデータ取得
   - 基本的なグラフ作成
   - ドキュメントを読む

2. **Level 3-4**: 実践力をつける（2-4週間）
   - 複数銘柄の比較
   - サブプロットの活用
   - テクニカル指標の実装

3. **Level 5**: 統合プロジェクト（4-8週間）
   - ダッシュボード作成
   - ポートフォリオ分析
   - 実際の投資判断への応用

4. **最上級**: 専門性を磨く（継続的）
   - カスタムアルゴリズム開発
   - リアルタイム分析
   - 機械学習との統合

### 参考リソース

- **yfinance公式**: https://github.com/ranaroussi/yfinance
- **Plotly公式**: https://plotly.com/python/
- **pandas公式**: https://pandas.pydata.org/

### 次のステップ

このガイドをマスターしたら:
- バックテスティングフレームワーク（backtrader, zipline）
- 機械学習（scikit-learn, TensorFlow）
- アルゴリズムトレーディング（QuantConnect, Alpaca）

---

**🎉 これで yfinance と Plotly の完全マスターの旅が始まります！**

コードを書いて、実験して、失敗して、学んでください。
最高のデータビジュアライゼーションとファイナンシャル分析を楽しんでください！
